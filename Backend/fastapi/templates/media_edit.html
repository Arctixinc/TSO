{% extends "base.html" %}

{% block title %}Edit {{ media_type|title }} - Telegram Stremio{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-10 space-y-8">

    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
        <div class="flex items-center gap-2">
            <a href="/media/manage?media_type={{ media_type }}" class="text-primary hover:underline flex items-center gap-1 text-sm sm:text-base">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                Back to {{ media_type|title }}s
            </a>
        </div>
        <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900">{{ media_details.title if media_details else 'Edit Media' }}</h1>
    </div>
    <p class="text-gray-500 text-sm sm:text-base">TMDB ID: {{ tmdb_id }} | DB Index: {{ db_index }}</p>

    <!-- Media Preview -->
    {% if media_details %}
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
        <!-- Poster & Info -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 flex flex-col items-center text-center">
            <img src="{{ media_details.poster or '/static/placeholder.jpg' }}" 
                 alt="{{ media_details.title }}" 
                 class="w-40 h-60 object-cover rounded-lg shadow-lg border-2 border-gray-200 mb-4"
                 onerror="this.src='https://via.placeholder.com/300x450/e5e7eb/9ca3af?text=No+Image'">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-2">{{ media_details.title }}</h2>
            <div class="flex flex-wrap justify-center gap-2 mb-2">
                {% if media_details.rating %}
                <span class="bg-yellow-400 text-black px-2 py-1 rounded font-semibold text-sm">‚≠ê {{ media_details.rating }}</span>
                {% endif %}
                <span class="bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded text-sm">{{ media_details.release_year }}</span>
            </div>
            <div class="flex flex-wrap justify-center gap-1">
                {% for genre in media_details.genres[:4] %}
                <span class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded-full text-xs">{{ genre }}</span>
                {% endfor %}
            </div>
        </div>

        <!-- Description -->
        <div class="sm:col-span-2 bg-white dark:bg-gray-800 rounded-lg shadow p-4 flex flex-col gap-4">
            {% if media_details.backdrop %}
            <div class="relative h-48 rounded-lg overflow-hidden">
                <img src="{{ media_details.backdrop }}" alt="{{ media_details.title }} backdrop" class="w-full h-full object-cover opacity-60" onerror="this.style.display='none'">
                <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
            </div>
            {% endif %}
            {% if media_details.description %}
            <div>
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Overview</h3>
                <p class="text-gray-600 dark:text-gray-300 text-sm sm:text-base leading-relaxed">{{ media_details.description }}</p>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Edit Form -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 space-y-6">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white">Edit Media Details</h3>
        <form onsubmit="updateMedia(event)" id="edit-form" class="grid grid-cols-1 sm:grid-cols-2 gap-6">

            <div class="sm:col-span-2">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Title *</label>
                <input type="text" id="title" name="title" value="{{ media_details.title if media_details else '' }}" class="w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white px-3 py-2 focus:ring-2 focus:ring-primary">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Release Year *</label>
                <input type="number" id="release_year" name="release_year" value="{{ media_details.release_year if media_details else '' }}" class="w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white px-3 py-2 focus:ring-2 focus:ring-primary">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Rating (0-10)</label>
                <input type="number" step="0.1" min="0" max="10" id="rating" name="rating" value="{{ media_details.rating if media_details else '' }}" class="w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white px-3 py-2 focus:ring-2 focus:ring-primary">
            </div>

            <div class="sm:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Poster URL</label>
                    <input type="url" id="poster" name="poster" value="{{ media_details.poster if media_details else '' }}" class="w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white px-3 py-2 focus:ring-2 focus:ring-primary">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Backdrop URL</label>
                    <input type="url" id="backdrop" name="backdrop" value="{{ media_details.backdrop if media_details else '' }}" class="w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white px-3 py-2 focus:ring-2 focus:ring-primary">
                </div>
            </div>

            <div class="sm:col-span-2">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Description</label>
                <textarea id="description" name="description" rows="4" class="w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white px-3 py-2 focus:ring-2 focus:ring-primary">{{ media_details.description if media_details else '' }}</textarea>
            </div>

            <div class="sm:col-span-2">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Genres (comma-separated)</label>
                <input type="text" id="genres" name="genres" value="{% if media_details and media_details.genres %}{{ media_details.genres|join(', ') }}{% endif %}" placeholder="Action, Comedy, Drama" class="w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white px-3 py-2 focus:ring-2 focus:ring-primary">
            </div>

            <div class="sm:col-span-2 flex flex-col sm:flex-row justify-end gap-4">
                <button type="button" onclick="window.history.back()" class="px-6 py-2 border rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">Cancel</button>
                <button type="submit" class="px-6 py-2 bg-primary text-white rounded-lg hover:opacity-90 transition-opacity">Save Changes</button>
            </div>

        </form>
    </div>

    <!-- Available Content -->
    {% if media_details %}
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 space-y-4">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white">Available Content</h3>

        {% if media_type == 'movie' and media_details.telegram %}
        <div class="space-y-3">
            {% set sorted_qualities = media_details.telegram|sort(attribute='quality') %}
            {% for quality in sorted_qualities %}
            <div class="flex flex-col sm:flex-row items-center justify-between p-3 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors gap-3">
                <div class="flex flex-col sm:flex-row items-center gap-2 sm:gap-4 flex-1">
                    <span class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded-full text-sm font-medium">{{ quality.quality }}</span>
                    <span class="text-gray-600 dark:text-gray-300 text-sm">{{ quality.size }}</span>
                    <span class="text-gray-500 dark:text-gray-400 text-sm break-all">{{ quality.name }}</span>
                </div>
                <button onclick="deleteQuality('{{ quality.quality }}')" class="text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-700 px-3 py-1 rounded transition-colors text-sm">Delete</button>
            </div>
            {% endfor %}
        </div>

        {% elif media_type == 'tv' and media_details.seasons %}
        <div class="space-y-4">
            {% for season in media_details.seasons|sort(attribute='season_number') %}
            <div class="border rounded-lg overflow-hidden border-gray-200 dark:border-gray-700">
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-gray-700 dark:to-gray-800 p-4 flex justify-between items-center">
                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white">Season {{ season.season_number }}</h4>
                    <div class="flex items-center gap-3">
                        <span class="text-sm text-gray-600 dark:text-gray-300">{{ season.episodes|length }} episode{{ 's' if season.episodes|length != 1 else '' }}</span>
                        <button onclick="toggleSeason({{ loop.index0 }})" class="text-blue-600 dark:text-blue-400">
                            <svg id="season-arrow-{{ loop.index0 }}" class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div id="season-content-{{ loop.index0 }}" class="season-content divide-y divide-gray-200 dark:divide-gray-700">
                    {% for episode in season.episodes|sort(attribute='episode_number') %}
                    <div class="p-3 sm:p-4 flex flex-col sm:flex-row items-start gap-3 sm:gap-4 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                        <div class="flex-shrink-0 w-12 h-12 bg-blue-100 dark:bg-blue-900 rounded-lg flex items-center justify-center">
                            <span class="text-sm font-bold text-blue-800 dark:text-blue-200">{{ episode.episode_number }}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h5 class="text-sm font-medium text-gray-900 dark:text-white mb-2">{{ episode.title }}</h5>
                            {% if episode.telegram %}
                            <div class="space-y-2">
                                {% set sorted_episode_qualities = episode.telegram|sort(attribute='quality') %}
                                {% for quality in sorted_episode_qualities %}
                                <div class="flex items-center justify-between p-2 rounded border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 gap-2">
                                    <div class="flex items-center gap-2">
                                        <span class="bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 px-2 py-1 rounded text-xs font-medium">{{ quality.quality }}</span>
                                        <span class="text-xs text-gray-500 dark:text-gray-400">{{ quality.size }}</span>
                                        <span class="text-xs text-gray-400 break-all">{{ quality.name }}</span>
                                    </div>
                                    <button onclick="deleteTVQuality({{ season.season_number }}, {{ episode.episode_number }}, '{{ quality.quality }}')" class="text-red-600 dark:text-red-400 px-2 py-1 rounded text-xs hover:bg-red-50 dark:hover:bg-red-700 transition-colors">Delete</button>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <p class="text-xs text-gray-400 text-center sm:text-left">No qualities available</p>
                            {% endif %}
                        </div>
                        <button onclick="deleteTVEpisode({{ season.season_number }}, {{ episode.episode_number }})" class="text-red-600 dark:text-red-400 px-2 py-1 rounded text-xs hover:bg-red-50 dark:hover:bg-red-700 transition-colors">Delete Episode</button>
                    </div>
                    {% endfor %}
                    <div class="p-4 text-center sm:text-left bg-gray-50 dark:bg-gray-700 border-t border-gray-200 dark:border-gray-600">
                        <button onclick="deleteTVSeason({{ season.season_number }})" class="text-red-600 dark:text-red-400 px-3 py-1 rounded hover:bg-red-50 dark:hover:bg-red-700 transition-colors">Delete Entire Season</button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-8 text-gray-400 dark:text-gray-500">
            <p>No content available</p>
        </div>
        {% endif %}
    </div>

</div>

<script>
const tmdbId = {{ tmdb_id }};
const dbIndex = {{ db_index }};
const mediaType = '{{ media_type }}';

// Toggle season visibility
function toggleSeason(seasonIndex) {
    const content = document.getElementById(`season-content-${seasonIndex}`);
    const arrow = document.getElementById(`season-arrow-${seasonIndex}`);
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        arrow.style.transform = 'rotate(0deg)';
    } else {
        content.style.display = 'none';
        arrow.style.transform = 'rotate(-90deg)';
    }
}

// Update media
async function updateMedia(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const updateData = {};
    
    // Convert form data to object
    for (let [key, value] of formData.entries()) {
        if (key === 'genres') {
            updateData[key] = value.split(',').map(g => g.trim()).filter(g => g);
        } else if (key === 'rating' || key === 'release_year' || key === 'runtime') {
            updateData[key] = value ? parseFloat(value) : null;
        } else {
            updateData[key] = value || null;
        }
    }
    
    try {
        const response = await fetch(`/api/media/update?tmdb_id=${tmdbId}&db_index=${dbIndex}&media_type=${mediaType}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updateData)
        });
        
        if (response.ok) {
            showSuccessMessage('Media updated successfully');
            setTimeout(() => location.reload(), 1000);
        } else {
            const error = await response.json();
            showErrorMessage(`Error updating media: ${error.detail || 'Unknown error'}`);
        }
    } catch (error) {
        console.error('Error updating media:', error);
        showErrorMessage('Error updating media. Please try again.');
    }
}

// Delete quality from movie
async function deleteQuality(quality) {
    if (!confirm(`Are you sure you want to delete the ${quality} quality?`)) return;
    
    try {
        const response = await fetch(`/api/media/delete-quality?tmdb_id=${tmdbId}&db_index=${dbIndex}&quality=${encodeURIComponent(quality)}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showSuccessMessage(`${quality} quality deleted successfully`);
            setTimeout(() => location.reload(), 1000);
        } else {
            const error = await response.json();
            showErrorMessage(`Error deleting quality: ${error.detail || 'Unknown error'}`);
        }
    } catch (error) {
        console.error('Error deleting quality:', error);
        showErrorMessage('Error deleting quality. Please try again.');
    }
}

// Delete TV quality
async function deleteTVQuality(season, episode, quality) {
    if (!confirm(`Are you sure you want to delete the ${quality} quality from Season ${season} Episode ${episode}?`)) return;
    
    try {
        const response = await fetch(`/api/media/delete-tv-quality?tmdb_id=${tmdbId}&db_index=${dbIndex}&season=${season}&episode=${episode}&quality=${encodeURIComponent(quality)}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showSuccessMessage(`${quality} quality deleted successfully`);
            setTimeout(() => location.reload(), 1000);
        } else {
            const error = await response.json();
            showErrorMessage(`Error deleting quality: ${error.detail || 'Unknown error'}`);
        }
    } catch (error) {
        console.error('Error deleting quality:', error);
        showErrorMessage('Error deleting quality. Please try again.');
    }
}

// Delete TV episode
async function deleteTVEpisode(season, episode) {
    if (!confirm(`Are you sure you want to delete Season ${season} Episode ${episode}?\n\nThis will remove the entire episode and all its qualities.`)) return;
    
    try {
        const response = await fetch(`/api/media/delete-tv-episode?tmdb_id=${tmdbId}&db_index=${dbIndex}&season=${season}&episode=${episode}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showSuccessMessage(`Episode ${episode} deleted successfully`);
            setTimeout(() => location.reload(), 1000);
        } else {
            const error = await response.json();
            showErrorMessage(`Error deleting episode: ${error.detail || 'Unknown error'}`);
        }
    } catch (error) {
        console.error('Error deleting episode:', error);
        showErrorMessage('Error deleting episode. Please try again.');
    }
}

// Delete TV season
async function deleteTVSeason(season) {
    if (!confirm(`Are you sure you want to delete the entire Season ${season}?\n\nThis will remove all episodes and qualities in this season. This action cannot be undone.`)) return;
    
    try {
        const response = await fetch(`/api/media/delete-tv-season?tmdb_id=${tmdbId}&db_index=${dbIndex}&season=${season}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showSuccessMessage(`Season ${season} deleted successfully`);
            setTimeout(() => location.reload(), 1000);
        } else {
            const error = await response.json();
            showErrorMessage(`Error deleting season: ${error.detail || 'Unknown error'}`);
        }
    } catch (error) {
        console.error('Error deleting season:', error);
        showErrorMessage('Error deleting season. Please try again.');
    }
}

// Show success message
function showSuccessMessage(message) {
    const msg = document.createElement('div');
    msg.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 sm:px-6 py-3 rounded-lg shadow-lg z-50 flex items-center max-w-sm';
    msg.innerHTML = `
        <svg class="w-4 h-4 sm:w-5 sm:h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
        <span class="text-sm">${message}</span>
    `;
    document.body.appendChild(msg);
    setTimeout(() => {
        if (document.body.contains(msg)) {
            document.body.removeChild(msg);
        }
    }, 4000);
}

// Show error message
function showErrorMessage(message) {
    const msg = document.createElement('div');
    msg.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 sm:px-6 py-3 rounded-lg shadow-lg z-50 flex items-center max-w-sm';
    msg.innerHTML = `
        <svg class="w-4 h-4 sm:w-5 sm:h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
        <span class="text-sm">${message}</span>
    `;
    document.body.appendChild(msg);
    setTimeout(() => {
        if (document.body.contains(msg)) {
            document.body.removeChild(msg);
        }
    }, 5000);
}

// Initialize page
document.addEventListener('DOMContentLoaded', () => {
    // Initialize all seasons as collapsed except the first one
    document.querySelectorAll('.season-content').forEach((content, index) => {
        if (index > 0) {
            content.style.display = 'none';
            document.getElementById(`season-arrow-${index}`).style.transform = 'rotate(-90deg)';
        }
    });
});
</script>

<style>
.season-content { transition: all 0.3s ease; }
.break-all { word-break: break-word; overflow-wrap: break-word; }
</style>
{% endblock %}

